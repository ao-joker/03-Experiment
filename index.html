<script src="https://d3js.org/d3.v4.min.js"></script>

<style>
</style>

<body>
  <h1> Experiment </h1>
  <label id="labelElement">
    Welcome to the experiment, press some buttons, answer some questions and don't worry your pretty lil head.
  </label>
  <p></p>
  <input id="readyButton" type="button" value="I'm ready to start" onclick="startButtonPress()">
</body>

<div id="vis"></div>

<script>
  // Initialize random data for testing
  let data = [...Array(10)]
  let selectedPoints = [...Array(2)]

  // Initialize Array for selecting next chart
  let chooseAChart = [
          makeTreeMap,
          makeStackedBarChart,
          makePieChart,
          makeTreeMap,
          makeStackedBarChart,
          makePieChart
  ]

  // Initialize Array to store the data
  let answers = []

  //TODO: Uncomment when ready chooseAChart.sort(() => Math.random() - 0.5)

  // Keep track of which page/trial we're on
  currTrial = 0
  currTrialType = ''

  // Create svg for charts to be placed
  let svg = d3.select('#vis')

  // Create constant text for in experiment instructions
  const instructions = "Here are the instructions for this experiment"
  let label = document.getElementById('labelElement')

  // Create experiment in progress page
  function startButtonPress() {
    svg.append('svg')
            .attr('height', 500)
            .attr('width', 500)
    label.innerText = instructions
    document.getElementById('readyButton')
      .remove()

    let input = document.createElement("INPUT")
    input.setAttribute('id', 'textEntry')
    input.setAttribute('type', 'text')
    input.setAttribute('placeholder', 'Enter guess here!')
    input.setAttribute('autofocus', 'true')
    document.body.appendChild(input)
    document.body.appendChild(document.createElement('br'))
    // TODO: Make the enter key press next button

    // Create next button
    let nextButton = document.createElement('button')
    nextButton.setAttribute('id', 'nextButton')
    nextButton.setAttribute('onclick', 'nextButtonPress()')
    nextButton.innerHTML = 'Next'
    document.body.appendChild(nextButton)

    currTrialType = chooseAChart[currTrial](randomizeData(), randomizeSelectedPoints())
  }

  // What to do when next button is pressed
  function nextButtonPress() {
    let textEntry = document.getElementById('textEntry')
    // Check that the entry space isn't blank
      if (textEntry.value !== '') {
        // Store the recorded data
        answers.push({type:currTrialType, error:calculateError(textEntry.value)})

        // As long as we're not and the end of the list set up for next trial
        if (currTrial < chooseAChart.length - 1){
          currTrial++
          textEntry.value = ''
          currTrialType = chooseAChart[currTrial](randomizeData(), randomizeSelectedPoints())

        } else {
          console.log('Thanks for taking the thing, all done')
          console.log(answers)
          // TODO: Make this change the screen
        }

      } else {
        console.log('Ya gotta enter a value')
        //TODO: Make this a cool lil warning
      }
  }

  function calculateError(reportedPercentage) {
    let truePercentage = Math.abs(data[selectedPoints[0]] - data[selectedPoints[1]])
    let error = Math.log2(Math.abs(reportedPercentage - truePercentage) + (1/8))
    if (error === -3) error = 0
    return error
  }
  
  function makeTreeMap(data, points) {
    // TODO: This is a stub
      console.log('called makeTreeMap')
    return 'Tree Map'
  }

  function makeStackedBarChart(data, points) {
    // TODO: This is a stub
    console.log('called makeStackedBarChart')
    return 'Stacked Bar Chart'
  }

  function makePieChart(data, points) {
    // TODO: This is a stub
    console.log('called makePieChart')
    return 'Pie Chart'
  }

  //Randomize data
  function randomizeData() {
    data = [...Array(10)].map(() => Math.floor(Math.random() * 101))
    return data
  }

  // select two data points
  function randomizeSelectedPoints() {
    selectedPoints = [...Array(2)].map(() => Math.floor(Math.random() * 10))
    while (selectedPoints[0] === selectedPoints[1]) {
      selectedPoints[1] = Math.floor(Math.random() * 10)
    }
    return selectedPoints
  }

</script>
